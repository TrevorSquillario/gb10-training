services:
  comfyui:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        # Pin ComfyUI to a known-good commit/tag if desired
        COMFYUI_REF: "master"
        # SageAttention ref (e.g., "main", "v2.2.0", or specific commit)
        SAGEATTN_REF: "main"

    container_name: comfyui

    # GPU enablement
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]

    # LAN exposure
    ports:
      - "8188:8188"

    environment:
      COMFYUI_PORT: "8188"
      # Optimized for Grace-Blackwell unified memory architecture
      # Key insight: DON'T use --gpu-only - let the unified memory fabric work naturally
      COMFYUI_FLAGS: "--listen 0.0.0.0 --port 8188 --bf16-unet --bf16-vae --bf16-text-enc --disable-pinned-memory --dont-upcast-attention"
      NVIDIA_VISIBLE_DEVICES: "all"
      NVIDIA_DRIVER_CAPABILITIES: "compute,utility"

      # Disable torch.compile/inductor - Triton doesn't support Blackwell sm_121a yet
      TORCH_COMPILE_DISABLE: "1"
      TORCHDYNAMO_DISABLE: "1"

      # Grace-Blackwell unified memory optimizations
      CUDA_CACHE_DISABLE: "1"
      PYTORCH_NO_CUDA_MEMORY_CACHING: "1"
      CUDA_DEVICE_MAX_CONNECTIONS: "1"
      CUDA_DEVICE_MAX_COPY_CONNECTIONS: "4"
      CUDA_MODULE_LOADING: "EAGER"
      #CUDA_MANAGED_FORCE_DEVICE_ALLOC: "1"
      OMP_NUM_THREADS: "20"
      CUBLAS_WORKSPACE_CONFIG: ":0:0"

    volumes:
      # Models from existing ComfyUI install (read-only)
      - ~/gb10/models/comfyui:/opt/ComfyUI/models

      # Custom nodes - comment out to use container-only (fresh) custom_nodes
      # If mounted, ComfyUI-Manager installs persist across container restarts
      - ~/gb10/comfyui/custom_nodes:/opt/ComfyUI/custom_nodes

      # Outputs/inputs/workflows - persistent across restarts
      - ~/gb10/comfyui/output:/opt/ComfyUI/output
      - ~/gb10/comfyui/input:/opt/ComfyUI/input
      - ./workflows:/opt/ComfyUI/user/default/workflows

      # Wheel cache (optional - for prebuilt wheels)
      - ~/gb10/comfyui/wheels:/opt/wheels

    networks:
      - ai-network

    # Health check - ComfyUI takes time to load, so generous start period
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8188/"]
      interval: 30s
      timeout: 10s
      start_period: 120s
      retries: 3

    restart: unless-stopped

networks:
  ai-network:
    name: ai-network
    driver: bridge
    external: true # This network was created in gb10-04

volumes:
  comfyuimini_workflows: